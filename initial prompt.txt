### Project Context

**Project Name:** OpenSPC (Event-Driven Process Control)
**Architecture:** Python Backend (FastAPI/LiteLLM), SQLite DB, MQTT/Sparkplug B Integration, React/Vue Frontend.
**Core Philosophy:** Decouple data ingestion ("Providers") from data analysis ("Engine"). Treat SPC violations as operational events.

---

### File 1: `01_architecture_overview.md`

```markdown
# OpenSPC Architecture Specification

## 1. System Overview
This system is a web-based Statistical Process Control (SPC) tool designed for hybrid manufacturing environments. It ingests data from two distinct sources:
1.  **Automated Tags:** High-frequency machine data via MQTT/UNS.
2.  **Manual Entry:** Operator data entry via Web UI.

Both sources feed into a normalized "Sample" pipeline, which triggers the Statistical Engine.

## 2. The "Provider" Abstraction
To solve the conflict between manual and automated data, we introduce **Data Providers**. A `Characteristic` (the quality metric) is attached to a `Provider`.

* **Tag Provider:**
    * Listens to a specific MQTT Topic.
    * **Trigger Strategy:** `On Change` OR `On Trigger Tag`.
    * **Buffer:** Accumulates readings if Subgroup Size ($n$) > 1.
* **Manual Provider:**
    * Exposes a UI Form.
    * **Trigger Strategy:** User clicks "Submit".
    * **Validation:** Immediate client-side validation against Spec Limits.

## 3. Data Flow Diagram

```mermaid
graph TD
    subgraph "Unified Namespace (UNS)"
        MQTT[MQTT Broker]
        MQTT -->|Topic Subscription| Ingest[Ingestion Service]
    end

    subgraph "User Interface"
        UI[Web Dashboard]
        UI -->|POST /api/sample| API[API Gateway]
    end

    subgraph "Core Backend"
        Ingest -->|Normalized Sample| Engine{SPC Engine}
        API -->|Normalized Sample| Engine
        
        Engine -->|1. Fetch Context| DB[(SQLite)]
        Engine -->|2. Get Rolling Window| Cache[Memory/Redis]
        Engine -->|3. Run Nelson Rules| Logic[Rule Library]
        
        Logic -->|Violation Detected| Alert[Alert Manager]
    end

    subgraph "Outputs"
        Alert -->|Write Record| DB
        Alert -->|Publish Event| MQTT
        Alert -->|Update UI| UI
    end

```

## 4. Key Entities

* **Characteristic:** The definition of *what* we are measuring (e.g., "Oven Temp" or "pH Level").
* **Sample:** A distinct event containing 1 or more measurements (depending on subgroup size).
* **Measurement:** The actual floating-point value(s).
* **Violation:** A record of a specific Nelson Rule breach linked to a Sample.

```

---

### File 2: `02_database_schema.sql`

```sql
-- OpenSPC Database Schema (SQLite Compatible)

-- ==========================================
-- 1. ISA-95 HIERARCHY
-- ==========================================
CREATE TABLE hierarchy (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    parent_id INTEGER,
    name TEXT NOT NULL,
    type TEXT CHECK(type IN ('Site', 'Area', 'Line', 'Cell', 'Unit')),
    FOREIGN KEY(parent_id) REFERENCES hierarchy(id)
);

-- ==========================================
-- 2. DEFINITIONS (The "Configuration")
-- ==========================================
CREATE TABLE characteristic (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    hierarchy_id INTEGER NOT NULL,
    name TEXT NOT NULL,
    description TEXT,
    
    -- SPC PARAMETERS
    subgroup_size INTEGER DEFAULT 1, -- n=1 (IMR), n=5 (XBar)
    target_value REAL,
    usl REAL, -- Upper Spec Limit (Voice of Customer)
    lsl REAL, -- Lower Spec Limit
    ucl REAL, -- Upper Control Limit (Voice of Process) - Can be NULL if Auto-Calc
    lcl REAL, -- Lower Control Limit
    
    -- DATA PROVIDER CONFIG
    provider_type TEXT CHECK(provider_type IN ('MANUAL', 'TAG')),
    mqtt_topic TEXT, -- Null if Manual
    trigger_tag TEXT, -- Optional secondary tag for automation
    
    FOREIGN KEY(hierarchy_id) REFERENCES hierarchy(id)
);

-- Mapping which Nelson Rules are active for a specific characteristic
CREATE TABLE characteristic_rules (
    char_id INTEGER,
    rule_id INTEGER, -- 1 through 8
    is_enabled BOOLEAN DEFAULT 1,
    PRIMARY KEY (char_id, rule_id),
    FOREIGN KEY(char_id) REFERENCES characteristic(id)
);

-- ==========================================
-- 3. EXECUTION DATA (The "History")
-- ==========================================
CREATE TABLE sample (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    char_id INTEGER NOT NULL,
    timestamp DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    -- CONTEXT (Crucial for UNS)
    batch_number TEXT,
    operator_id TEXT,
    is_excluded BOOLEAN DEFAULT 0, -- If True, excluded from future Calc
    
    FOREIGN KEY(char_id) REFERENCES characteristic(id)
);

CREATE TABLE measurement (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    sample_id INTEGER NOT NULL,
    value REAL NOT NULL,
    FOREIGN KEY(sample_id) REFERENCES sample(id)
);

-- ==========================================
-- 4. ALARMS & EXCEPTIONS
-- ==========================================
CREATE TABLE violation (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    sample_id INTEGER NOT NULL,
    rule_id INTEGER NOT NULL,
    rule_name TEXT, -- e.g., "Trend Detected"
    severity TEXT CHECK(severity IN ('WARNING', 'CRITICAL')),
    
    -- WORKFLOW
    acknowledged BOOLEAN DEFAULT 0,
    ack_user TEXT,
    ack_reason TEXT, -- "Tool Change", "Raw Material", "False Alarm"
    ack_timestamp DATETIME,
    
    FOREIGN KEY(sample_id) REFERENCES sample(id)
);

-- ==========================================
-- 5. SEED DATA
-- ==========================================
-- Hierarchy
INSERT INTO hierarchy (id, name, type) VALUES (1, 'Raleigh_Site', 'Site');
INSERT INTO hierarchy (id, parent_id, name, type) VALUES (2, 1, 'Bottling_Line_A', 'Line');

-- Manual Characteristic (pH Level)
INSERT INTO characteristic (hierarchy_id, name, subgroup_size, usl, lsl, ucl, lcl, provider_type)
VALUES (2, 'Product_pH', 1, 7.8, 6.8, 7.6, 7.0, 'MANUAL');

-- Automated Characteristic (Fill Volume)
INSERT INTO characteristic (hierarchy_id, name, subgroup_size, target_value, provider_type, mqtt_topic)
VALUES (2, 'Fill_Volume_mL', 5, 355.0, 'TAG', 'spc/Raleigh/BottlingA/Filler/Vol');

-- Enable Rules for pH
INSERT INTO characteristic_rules (char_id, rule_id) VALUES (1, 1); -- Rule 1
INSERT INTO characteristic_rules (char_id, rule_id) VALUES (1, 3); -- Rule 3 (Trend)

```

---

### File 3: `03_nelson_rules_spec.md`

```markdown
# Nelson Rules Logic Specification

The SPC Engine must maintain a "Rolling Window" of the last **15 to 25 samples** in memory to evaluate these rules effectively.

**Sigma Calculation:**
$\sigma$ must be estimated using $\bar{R} / d_2$ or $S / c_4$. Do not use standard deviation of the population.

## The 8 Standard Rules

### Rule 1: The Outlier (Critical)
* **Logic:** One point beyond Zone A (> 3$\sigma$ from Mean).
* **Meaning:** Special cause variation. Process has gone unstable.
* **Action:** Stop/Check immediately.

### Rule 2: The Shift
* **Logic:** 9 points in a row on the same side of the Center Line.
* **Meaning:** The process average has shifted.
* **Reset:** Requires crossing the center line to reset the counter.

### Rule 3: The Trend
* **Logic:** 6 points in a row, all increasing OR all decreasing.
* **Meaning:** Tool wear, temperature buildup, or chemical depletion.

### Rule 4: The Alternator
* **Logic:** 14 points alternating up and down (Up, Down, Up, Down...).
* **Meaning:** Over-adjustment by operator or sampling from two distinct streams alternately.

### Rule 5: Zone A Warning
* **Logic:** 2 out of 3 consecutive points in Zone A (> 2$\sigma$) or beyond.
* **Meaning:** Early warning of a shift.

### Rule 6: Zone B Warning
* **Logic:** 4 out of 5 consecutive points in Zone B (> 1$\sigma$) or beyond.
* **Meaning:** Moderate process shift.

### Rule 7: Stratification (Hugging the Mean)
* **Logic:** 15 consecutive points within Zone C (< 1$\sigma$).
* **Meaning:** Control limits are calculated incorrectly (too wide) or data is fabricated/smoothed.

### Rule 8: The Void (Mixture)
* **Logic:** 8 consecutive points with none in Zone C (> 1$\sigma$ on either side).
* **Meaning:** Two distinct processes running in parallel (e.g., two mold cavities) being measured as one.

## Implementation Note
For the `check_rules(history, current_sample)` function:
1.  Filter `history` to exclude samples marked `is_excluded`.
2.  Calculate dynamic Z-scores for the window.
3.  Return a list of `Violation` objects.

```

---

### File 4: `04_uns_payload_spec.json`

```json
/* Specification for the Sparkplug B / MQTT Payload.
   When the SPC Engine processes a sample, it publishes this object.
   Topic Structure: spc/<Group>/<Node>/<Device>/<CharacteristicName>
*/

{
  "timestamp": 1706890000000,
  "metrics": [
    {
      "name": "Value",
      "type": "Float",
      "value": 7.45,
      "properties": {
        "engUnit": "pH"
      }
    },
    {
      "name": "Control/UCL",
      "type": "Float",
      "value": 7.6
    },
    {
      "name": "Control/LCL",
      "type": "Float",
      "value": 7.0
    },
    {
      "name": "State/InControl",
      "type": "Boolean",
      "value": false
    },
    {
      "name": "State/ActiveRules",
      "type": "String", 
      "value": "Rule 1, Rule 3"
    },
    {
      "name": "Context/Operator",
      "type": "String",
      "value": "J.Smith"
    }
  ]
}

```

---

### File 5: `05_frontend_requirements.md`

```markdown
# UI/UX Specifications

## 1. Dashboard (Operator View)
**Layout:** Split Screen.

* **Left Panel: The To-Do List**
    * List of Manual Characteristics.
    * **Visuals:** Color-coded cards.
        * *Grey:* No sample due.
        * *Yellow:* Sample due (Time-based logic).
        * *Red:* Last sample was OOC (Out of Control).
    * **Interaction:** Clicking a card opens the "Input Modal".

* **Input Modal:**
    * Large numeric input.
    * Live validation: If value > USL, input border turns Red immediately.
    * "Add Comment" field.

* **Right Panel: Visualization**
    * **Primary Chart:** X-Bar or I-MR Chart.
        * Library Recommendation: `Recharts` (React) or `Chart.js`.
        * Zones: Background bands (Green=1$\sigma$, Yellow=2$\sigma$, Red=3$\sigma$).
        * Points: Clickable to view metadata.
    * **Secondary Chart:** Histogram (Bell Curve) to show distribution vs Specs.

## 2. Configuration (Engineer View)
**Layout:** Tree + Detail.

* **Tree:** ISA-95 Hierarchy (Site -> Line -> Machine).
* **Detail Form:**
    * **Provider Selector:** Radio button [Manual | Tag].
    * **Tag Browser:** If "Tag" is selected, provide a tree browser to pick the MQTT topic (simulated or real).
    * **Rule Toggles:** A grid of checkboxes to enable/disable specific Nelson Rules for this characteristic (e.g., disable Rule 4 for noisy data).
    * **Limit Management:**
        * Input fields for USL/LSL.
        * Button: "Recalculate Control Limits" (queries DB for last N samples and updates UCL/LCL).

## 3. Alert Management
* **Toast Notifications:** When a new sample triggers a violation, a global toast must appear.
* **Ack Workflow:**
    * Violated points on the chart pulse red.
    * Clicking the point opens the "Acknowledge Violation" dialog.
    * **Dropdown:** Select Reason Code (Standardized list).

```