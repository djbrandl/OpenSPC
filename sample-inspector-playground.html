<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sample Inspector — Design Playground</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg: #0a0f1a;
    --card: #111827;
    --card-raised: #1a2235;
    --border: #1e293b;
    --border-focus: #334155;
    --text: #e2e8f0;
    --text-muted: #94a3b8;
    --text-dim: #64748b;
    --primary: #6366f1;
    --primary-soft: rgba(99,102,241,0.12);
    --primary-hover: #818cf8;
    --green: #22c55e;
    --green-soft: rgba(34,197,94,0.12);
    --amber: #f59e0b;
    --amber-soft: rgba(245,158,11,0.12);
    --red: #ef4444;
    --red-soft: rgba(239,68,68,0.12);
    --blue: #3b82f6;
    --blue-soft: rgba(59,130,246,0.12);
    --radius: 10px;
    --radius-sm: 6px;
    --font: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
    --mono: 'SF Mono', 'Cascadia Code', 'Fira Code', 'JetBrains Mono', monospace;
  }

  html, body { height: 100%; }
  body {
    font-family: var(--font);
    background: var(--bg);
    color: var(--text);
    display: flex;
    overflow: hidden;
  }

  /* ─── CONTROLS PANEL ─── */
  .controls {
    width: 300px;
    min-width: 300px;
    background: var(--card);
    border-right: 1px solid var(--border);
    overflow-y: auto;
    padding: 20px 16px;
    display: flex;
    flex-direction: column;
    gap: 20px;
  }
  .controls h1 {
    font-size: 15px;
    font-weight: 700;
    letter-spacing: -0.01em;
    color: var(--text);
    margin-bottom: 2px;
  }
  .controls h1 small {
    display: block;
    font-size: 11px;
    font-weight: 400;
    color: var(--text-dim);
    margin-top: 4px;
    letter-spacing: 0;
  }

  .ctrl-group { display: flex; flex-direction: column; gap: 10px; }
  .ctrl-group-title {
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-dim);
    padding-bottom: 4px;
    border-bottom: 1px solid var(--border);
  }

  .ctrl-row { display: flex; flex-direction: column; gap: 4px; }
  .ctrl-label {
    font-size: 11px;
    font-weight: 500;
    color: var(--text-muted);
  }

  /* Radio group */
  .radio-group { display: flex; flex-wrap: wrap; gap: 4px; }
  .radio-group label {
    font-size: 11px;
    padding: 5px 10px;
    border-radius: var(--radius-sm);
    border: 1px solid var(--border);
    cursor: pointer;
    color: var(--text-muted);
    transition: all 0.15s;
    white-space: nowrap;
  }
  .radio-group label:hover { border-color: var(--border-focus); color: var(--text); }
  .radio-group input { display: none; }
  .radio-group input:checked + span {
    /* handled by parent label */
  }
  .radio-group label:has(input:checked) {
    background: var(--primary-soft);
    border-color: var(--primary);
    color: var(--primary-hover);
  }

  /* Toggle */
  .toggle-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 4px 0;
  }
  .toggle-row .ctrl-label { margin: 0; }
  .toggle {
    width: 36px; height: 20px;
    background: var(--border);
    border-radius: 10px;
    position: relative;
    cursor: pointer;
    transition: background 0.2s;
    border: none;
    flex-shrink: 0;
  }
  .toggle::after {
    content: '';
    position: absolute;
    width: 14px; height: 14px;
    background: #fff;
    border-radius: 50%;
    top: 3px; left: 3px;
    transition: transform 0.2s;
  }
  .toggle.on { background: var(--primary); }
  .toggle.on::after { transform: translateX(16px); }

  /* Preset buttons */
  .presets { display: flex; flex-wrap: wrap; gap: 4px; }
  .preset-btn {
    font-size: 10px;
    padding: 5px 10px;
    border-radius: var(--radius-sm);
    border: 1px solid var(--border);
    background: transparent;
    color: var(--text-muted);
    cursor: pointer;
    transition: all 0.15s;
    font-family: var(--font);
  }
  .preset-btn:hover { border-color: var(--primary); color: var(--primary-hover); }
  .preset-btn.active {
    background: var(--primary-soft);
    border-color: var(--primary);
    color: var(--primary-hover);
  }

  /* ─── MAIN AREA ─── */
  .main {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  /* Preview area */
  .preview-area {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 32px;
    overflow: auto;
    background:
      radial-gradient(circle at 30% 20%, rgba(99,102,241,0.04) 0%, transparent 50%),
      radial-gradient(circle at 70% 80%, rgba(34,197,94,0.03) 0%, transparent 50%),
      var(--bg);
  }

  /* ─── MODAL PREVIEW ─── */
  .modal-backdrop {
    width: 100%;
    max-width: 720px;
    max-height: 100%;
  }

  .modal {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 16px;
    box-shadow: 0 25px 60px rgba(0,0,0,0.5), 0 0 0 1px rgba(255,255,255,0.03) inset;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    max-height: 80vh;
    animation: modalIn 0.25s ease-out;
  }
  @keyframes modalIn {
    from { opacity: 0; transform: translateY(8px) scale(0.98); }
    to { opacity: 1; transform: translateY(0) scale(1); }
  }

  .modal.layout-sidebar {
    flex-direction: row;
    max-width: 820px;
  }

  /* Header */
  .modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
  }
  .modal-header-left { display: flex; align-items: center; gap: 12px; }
  .modal-header h2 {
    font-size: 15px;
    font-weight: 600;
  }
  .close-btn {
    width: 28px; height: 28px;
    display: flex; align-items: center; justify-content: center;
    border-radius: var(--radius-sm);
    border: none;
    background: transparent;
    color: var(--text-muted);
    cursor: pointer;
    font-size: 16px;
    transition: all 0.15s;
  }
  .close-btn:hover { background: rgba(255,255,255,0.06); color: var(--text); }

  /* Point shape indicator */
  .point-shape {
    width: 14px; height: 14px;
    flex-shrink: 0;
  }
  .point-shape.circle { border-radius: 50%; background: var(--green); }
  .point-shape.diamond {
    width: 12px; height: 12px;
    background: var(--red);
    transform: rotate(45deg);
    border-radius: 2px;
  }
  .point-shape.triangle {
    width: 0; height: 0;
    border-left: 7px solid transparent;
    border-right: 7px solid transparent;
    border-bottom: 12px solid var(--amber);
    background: transparent;
  }

  /* Status chips */
  .chip {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-size: 10px;
    font-weight: 600;
    padding: 3px 8px;
    border-radius: 20px;
    letter-spacing: 0.01em;
    white-space: nowrap;
  }
  .chip-green { background: var(--green-soft); color: var(--green); }
  .chip-red { background: var(--red-soft); color: var(--red); }
  .chip-amber { background: var(--amber-soft); color: var(--amber); }
  .chip-blue { background: var(--blue-soft); color: var(--blue); }
  .chip-muted { background: rgba(148,163,184,0.1); color: var(--text-dim); }

  /* ─── OVERVIEW SECTION ─── */
  .overview {
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
  }
  .overview-top {
    display: flex;
    align-items: flex-start;
    gap: 16px;
    margin-bottom: 12px;
  }
  .overview-value {
    text-align: center;
    min-width: 90px;
    flex-shrink: 0;
  }
  .overview-value .label {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-dim);
    margin-bottom: 4px;
  }
  .overview-value .number {
    font-family: var(--mono);
    font-size: 26px;
    font-weight: 700;
    line-height: 1;
  }
  .overview-value .unit {
    font-size: 11px;
    color: var(--text-muted);
    margin-top: 4px;
  }
  .overview-meta {
    flex: 1;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 6px 16px;
  }
  .meta-item {
    font-size: 11px;
    display: flex;
    gap: 6px;
  }
  .meta-item .meta-label { color: var(--text-dim); white-space: nowrap; }
  .meta-item .meta-value { color: var(--text-muted); font-family: var(--mono); font-size: 11px; }
  .overview-chips {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
  }

  /* ─── TABS ─── */
  .tab-bar {
    display: flex;
    gap: 0;
    padding: 0 20px;
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
    overflow-x: auto;
  }
  .tab-btn {
    font-family: var(--font);
    font-size: 12px;
    font-weight: 500;
    color: var(--text-dim);
    background: none;
    border: none;
    padding: 10px 14px;
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.15s;
    white-space: nowrap;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .tab-btn:hover { color: var(--text-muted); }
  .tab-btn.active {
    color: var(--primary-hover);
    border-bottom-color: var(--primary);
  }
  .tab-badge {
    font-size: 9px;
    min-width: 16px;
    height: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    font-weight: 600;
  }
  .tab-badge-red { background: var(--red-soft); color: var(--red); }
  .tab-badge-amber { background: var(--amber-soft); color: var(--amber); }

  /* ─── TAB CONTENT ─── */
  .tab-content {
    flex: 1;
    overflow-y: auto;
    padding: 16px 20px;
    min-height: 0;
  }
  .tab-panel { display: none; }
  .tab-panel.active { display: block; }

  /* ─── MEASUREMENTS ─── */
  .measurement-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
    gap: 8px;
    margin-bottom: 16px;
  }
  .measurement-cell {
    background: var(--card-raised);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 8px 10px;
    text-align: center;
  }
  .measurement-cell .m-label {
    font-size: 9px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-dim);
    margin-bottom: 4px;
  }
  .measurement-cell .m-value {
    font-family: var(--mono);
    font-size: 14px;
    font-weight: 600;
    color: var(--text);
  }
  .measurement-cell.editable {
    border-color: var(--primary);
    border-style: dashed;
    cursor: text;
  }
  .measurement-cell.editable .m-value {
    color: var(--primary-hover);
  }

  .stats-row {
    display: flex;
    gap: 16px;
    padding: 10px 14px;
    background: var(--card-raised);
    border-radius: var(--radius-sm);
    border: 1px solid var(--border);
    margin-bottom: 16px;
  }
  .stat-item {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }
  .stat-item .stat-label {
    font-size: 9px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-dim);
  }
  .stat-item .stat-value {
    font-family: var(--mono);
    font-size: 13px;
    font-weight: 600;
  }

  /* Mini bar chart */
  .mini-bars {
    display: flex;
    align-items: flex-end;
    gap: 3px;
    height: 40px;
    padding: 8px 14px;
    background: var(--card-raised);
    border-radius: var(--radius-sm);
    border: 1px solid var(--border);
    margin-bottom: 16px;
    position: relative;
  }
  .mini-bars .limit-line {
    position: absolute;
    left: 14px; right: 14px;
    border-top: 1px dashed;
    pointer-events: none;
  }
  .mini-bars .limit-line.ucl { top: 4px; border-color: var(--red); opacity: 0.5; }
  .mini-bars .limit-line.lcl { bottom: 4px; border-color: var(--red); opacity: 0.5; }
  .mini-bars .limit-line.center { top: 50%; border-color: var(--text-dim); opacity: 0.3; border-top-style: dotted; }
  .bar {
    flex: 1;
    border-radius: 2px 2px 0 0;
    min-height: 3px;
    transition: height 0.2s;
  }

  /* Edit reason area */
  .edit-reason {
    margin-top: 12px;
    padding: 12px;
    background: var(--card-raised);
    border: 1px dashed var(--primary);
    border-radius: var(--radius-sm);
  }
  .edit-reason label {
    font-size: 11px;
    font-weight: 600;
    color: var(--primary-hover);
    display: block;
    margin-bottom: 6px;
  }
  .edit-reason textarea, .edit-reason .fake-textarea {
    width: 100%;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 8px 10px;
    color: var(--text-muted);
    font-size: 11px;
    font-family: var(--font);
    resize: none;
    height: 48px;
  }
  .edit-reason .btn-row {
    display: flex;
    justify-content: flex-end;
    gap: 8px;
    margin-top: 8px;
  }

  /* Buttons */
  .btn {
    font-family: var(--font);
    font-size: 11px;
    font-weight: 600;
    padding: 6px 14px;
    border-radius: var(--radius-sm);
    border: 1px solid var(--border);
    cursor: pointer;
    transition: all 0.15s;
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }
  .btn-primary {
    background: var(--primary);
    border-color: var(--primary);
    color: #fff;
  }
  .btn-primary:hover { background: var(--primary-hover); }
  .btn-ghost {
    background: transparent;
    color: var(--text-muted);
  }
  .btn-ghost:hover { background: rgba(255,255,255,0.05); color: var(--text); }
  .btn-amber {
    background: var(--amber-soft);
    border-color: rgba(245,158,11,0.3);
    color: var(--amber);
  }
  .btn-amber:hover { background: rgba(245,158,11,0.2); }
  .btn-red {
    background: var(--red-soft);
    border-color: rgba(239,68,68,0.3);
    color: var(--red);
  }

  .btn[disabled] {
    opacity: 0.4;
    cursor: not-allowed;
  }

  /* ─── VIOLATIONS ─── */
  .violation-card {
    border: 1px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
    margin-bottom: 12px;
  }
  .violation-card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 14px;
    background: var(--card-raised);
    cursor: pointer;
    gap: 10px;
  }
  .violation-card-header:hover { background: rgba(255,255,255,0.03); }
  .violation-card-left { display: flex; align-items: center; gap: 10px; }
  .violation-rule-num {
    font-family: var(--mono);
    font-size: 10px;
    font-weight: 700;
    width: 28px; height: 28px;
    display: flex; align-items: center; justify-content: center;
    border-radius: 50%;
    flex-shrink: 0;
  }
  .violation-rule-num.critical { background: var(--red-soft); color: var(--red); }
  .violation-rule-num.warning { background: var(--amber-soft); color: var(--amber); }
  .violation-rule-num.info { background: var(--blue-soft); color: var(--blue); }
  .violation-name { font-size: 13px; font-weight: 600; }
  .violation-short { font-size: 11px; color: var(--text-dim); }

  .violation-body {
    padding: 14px;
    border-top: 1px solid var(--border);
  }
  .violation-section {
    margin-bottom: 12px;
  }
  .violation-section:last-child { margin-bottom: 0; }
  .violation-section-title {
    font-size: 9px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--text-dim);
    margin-bottom: 4px;
  }
  .violation-section p {
    font-size: 12px;
    line-height: 1.5;
    color: var(--text-muted);
  }

  /* Mini sparkline SVG */
  .violation-sparkline {
    width: 100%;
    height: 32px;
    margin-bottom: 10px;
  }
  .violation-sparkline svg { width: 100%; height: 100%; }

  .ack-area {
    padding: 10px 14px;
    background: rgba(245,158,11,0.04);
    border-top: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
  }
  .ack-area .ack-text {
    font-size: 11px;
    color: var(--text-dim);
  }

  /* ─── ANNOTATIONS ─── */
  .annotation-item {
    display: flex;
    gap: 10px;
    padding: 10px 0;
    border-bottom: 1px solid var(--border);
  }
  .annotation-item:last-child { border-bottom: none; }
  .annotation-color-dot {
    width: 10px; height: 10px;
    border-radius: 50%;
    flex-shrink: 0;
    margin-top: 4px;
  }
  .annotation-content { flex: 1; }
  .annotation-text { font-size: 12px; color: var(--text); line-height: 1.4; }
  .annotation-meta { font-size: 10px; color: var(--text-dim); margin-top: 4px; }

  .add-annotation-form {
    margin-top: 12px;
    padding: 12px;
    background: var(--card-raised);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
  }
  .add-annotation-form .form-row {
    display: flex;
    gap: 8px;
    align-items: flex-end;
  }
  .add-annotation-form .fake-input {
    flex: 1;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 7px 10px;
    color: var(--text-dim);
    font-size: 11px;
  }
  .add-annotation-form .color-dot-input {
    width: 28px; height: 28px;
    border-radius: 50%;
    border: 2px solid var(--border);
    cursor: pointer;
    flex-shrink: 0;
  }

  /* ─── EDIT HISTORY ─── */
  .history-timeline {
    position: relative;
    padding-left: 20px;
  }
  .history-timeline::before {
    content: '';
    position: absolute;
    left: 5px;
    top: 4px;
    bottom: 4px;
    width: 2px;
    background: var(--border);
    border-radius: 1px;
  }
  .history-entry {
    position: relative;
    padding-bottom: 16px;
  }
  .history-entry:last-child { padding-bottom: 0; }
  .history-entry::before {
    content: '';
    position: absolute;
    left: -20px;
    top: 5px;
    width: 12px; height: 12px;
    border-radius: 50%;
    border: 2px solid var(--primary);
    background: var(--card);
  }
  .history-entry .entry-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 4px;
  }
  .history-entry .entry-who { font-size: 12px; font-weight: 600; color: var(--text); }
  .history-entry .entry-when { font-size: 10px; color: var(--text-dim); }
  .history-entry .entry-reason {
    font-size: 11px;
    color: var(--text-muted);
    margin-bottom: 6px;
    font-style: italic;
  }
  .history-entry .entry-diff {
    display: flex;
    gap: 8px;
    font-family: var(--mono);
    font-size: 11px;
  }
  .entry-diff .diff-old {
    text-decoration: line-through;
    color: var(--red);
    opacity: 0.7;
  }
  .entry-diff .diff-arrow { color: var(--text-dim); }
  .entry-diff .diff-new { color: var(--green); }

  /* ─── SECTIONED LAYOUT (scrollable) ─── */
  .section-layout .section-block {
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
  }
  .section-layout .section-block:last-child { border-bottom: none; }
  .section-block-title {
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--text-dim);
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  /* ─── SIDEBAR LAYOUT ─── */
  .sidebar-left {
    width: 200px;
    min-width: 200px;
    border-right: 1px solid var(--border);
    padding: 16px 0;
    overflow-y: auto;
    flex-shrink: 0;
  }
  .sidebar-left .sidebar-item {
    font-size: 12px;
    font-weight: 500;
    color: var(--text-dim);
    padding: 8px 16px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.15s;
    border-left: 2px solid transparent;
  }
  .sidebar-left .sidebar-item:hover {
    color: var(--text-muted);
    background: rgba(255,255,255,0.02);
  }
  .sidebar-left .sidebar-item.active {
    color: var(--primary-hover);
    background: var(--primary-soft);
    border-left-color: var(--primary);
  }
  .sidebar-main {
    flex: 1;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
  }

  /* Excluded overlay */
  .excluded-overlay {
    position: relative;
  }
  .excluded-overlay::after {
    content: 'EXCLUDED';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) rotate(-12deg);
    font-size: 48px;
    font-weight: 900;
    color: rgba(239,68,68,0.08);
    letter-spacing: 0.15em;
    pointer-events: none;
    white-space: nowrap;
  }

  /* ─── PROMPT OUTPUT ─── */
  .prompt-area {
    border-top: 1px solid var(--border);
    background: var(--card);
    padding: 12px 20px;
    flex-shrink: 0;
  }
  .prompt-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 8px;
  }
  .prompt-header span {
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--text-dim);
  }
  .copy-btn {
    font-family: var(--font);
    font-size: 10px;
    font-weight: 600;
    padding: 4px 12px;
    border-radius: var(--radius-sm);
    border: 1px solid var(--primary);
    background: var(--primary-soft);
    color: var(--primary-hover);
    cursor: pointer;
    transition: all 0.15s;
  }
  .copy-btn:hover { background: var(--primary); color: #fff; }
  .copy-btn.copied { background: var(--green); border-color: var(--green); color: #fff; }
  .prompt-text {
    font-size: 12px;
    line-height: 1.6;
    color: var(--text-muted);
    max-height: 100px;
    overflow-y: auto;
  }

  /* Scrollbars */
  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
  ::-webkit-scrollbar-thumb:hover { background: var(--border-focus); }
</style>
</head>
<body>

<!-- ════ CONTROLS ════ -->
<div class="controls">
  <h1>
    Sample Inspector
    <small>Design playground for the data-point click modal</small>
  </h1>

  <div class="ctrl-group">
    <div class="ctrl-group-title">Presets</div>
    <div class="presets" id="presets"></div>
  </div>

  <div class="ctrl-group">
    <div class="ctrl-group-title">Layout</div>
    <div class="ctrl-row">
      <div class="radio-group" id="layout-radios"></div>
    </div>
  </div>

  <div class="ctrl-group">
    <div class="ctrl-group-title">User Role</div>
    <div class="ctrl-row">
      <div class="radio-group" id="role-radios"></div>
    </div>
  </div>

  <div class="ctrl-group">
    <div class="ctrl-group-title">Sample State</div>
    <div class="ctrl-row">
      <div class="ctrl-label">Violation Preset</div>
      <div class="radio-group" id="violation-radios"></div>
    </div>
    <div class="toggle-row">
      <span class="ctrl-label">Has Violations</span>
      <button class="toggle" id="tog-violations" onclick="toggleState('hasViolations')"></button>
    </div>
    <div class="toggle-row">
      <span class="ctrl-label">Is Modified</span>
      <button class="toggle" id="tog-modified" onclick="toggleState('isModified')"></button>
    </div>
    <div class="toggle-row">
      <span class="ctrl-label">Is Undersized</span>
      <button class="toggle" id="tog-undersized" onclick="toggleState('isUndersized')"></button>
    </div>
    <div class="toggle-row">
      <span class="ctrl-label">Is Excluded</span>
      <button class="toggle" id="tog-excluded" onclick="toggleState('isExcluded')"></button>
    </div>
    <div class="toggle-row">
      <span class="ctrl-label">Has Annotations</span>
      <button class="toggle" id="tog-annotations" onclick="toggleState('hasAnnotations')"></button>
    </div>
  </div>

  <div class="ctrl-group">
    <div class="ctrl-group-title">Display</div>
    <div class="toggle-row">
      <span class="ctrl-label">Show Mini Bar Chart</span>
      <button class="toggle" id="tog-bars" onclick="toggleState('showBars')"></button>
    </div>
    <div class="toggle-row">
      <span class="ctrl-label">Expand Violation Details</span>
      <button class="toggle" id="tog-expand-viol" onclick="toggleState('expandViolations')"></button>
    </div>
    <div class="toggle-row">
      <span class="ctrl-label">Edit Mode Active</span>
      <button class="toggle" id="tog-editing" onclick="toggleState('isEditing')"></button>
    </div>
  </div>
</div>

<!-- ════ MAIN ════ -->
<div class="main">
  <div class="preview-area">
    <div class="modal-backdrop">
      <div class="modal" id="modal-root">
        <!-- Rendered by JS -->
      </div>
    </div>
  </div>

  <div class="prompt-area">
    <div class="prompt-header">
      <span>Generated Prompt</span>
      <button class="copy-btn" id="copy-btn" onclick="copyPrompt()">Copy Prompt</button>
    </div>
    <div class="prompt-text" id="prompt-output"></div>
  </div>
</div>

<script>
// ════════════════════════════════════════════════════════════
// DATA
// ════════════════════════════════════════════════════════════

const NELSON_RULES = {
  1: { name: 'Beyond 3\u03c3', short: 'Single point outside control limits', severity: 'CRITICAL',
    description: 'A single point falls outside the 3-sigma control limits (beyond UCL or LCL). This is the most severe violation as it indicates an extreme deviation from the process mean.',
    cause: 'Equipment malfunction, measurement error, material defect, operator error, or a significant process upset.',
    action: 'Immediately investigate the assignable cause. Check recent changes to materials, equipment, or procedures. Verify measurement accuracy.' },
  2: { name: 'Zone Bias', short: '9 consecutive on same side', severity: 'WARNING',
    description: 'Nine or more consecutive points fall on the same side of the center line. This indicates a shift in the process average.',
    cause: 'Process mean has shifted due to tool wear, different raw material batch, environmental change, or calibration drift.',
    action: 'Investigate what changed around the time the shift began. Check for material lot changes, equipment adjustments, or environmental factors.' },
  3: { name: 'Trend', short: '6 consecutive increasing/decreasing', severity: 'WARNING',
    description: 'Six or more consecutive points are continuously increasing or decreasing, indicating a trend in the process.',
    cause: 'Tool wear, gradual equipment degradation, temperature drift, operator fatigue, or depleting consumables.',
    action: 'Identify and address the source of drift. Consider implementing preventive maintenance or recalibration schedules.' },
  4: { name: 'Oscillation', short: '14 consecutive alternating', severity: 'WARNING',
    description: 'Fourteen or more consecutive points alternate up and down in a sawtooth pattern, indicating over-adjustment or two alternating causes.',
    cause: 'Over-correction by operators, alternating materials from two sources, fixture switching, or inspection by alternating gauges.',
    action: 'Review operator adjustment procedures. Check if multiple material sources or equipment are being alternated.' },
  5: { name: 'Zone A Pattern', short: '2 of 3 beyond 2\u03c3', severity: 'WARNING',
    description: 'Two out of three consecutive points fall in Zone A (beyond 2\u03c3 from center) on the same side.',
    cause: 'Process variance has increased, or the mean is shifting. Early warning of a potential Rule 1 violation.',
    action: 'Monitor closely for further deterioration. Investigate recent changes that may have increased variability.' },
  6: { name: 'Zone B Pattern', short: '4 of 5 beyond 1\u03c3', severity: 'WARNING',
    description: 'Four out of five consecutive points fall in Zone B or beyond (beyond 1\u03c3 from center) on the same side.',
    cause: 'Small shift in process mean or gradually increasing variance.',
    action: 'Investigate potential causes of shift. This is often an early indicator before a more serious violation occurs.' },
  7: { name: 'Zone C Stability', short: '15 consecutive within 1\u03c3', severity: 'INFO',
    description: 'Fifteen consecutive points fall within Zone C. While this looks "good," it indicates stratification or mixture.',
    cause: 'Data from multiple streams being mixed, incorrect subgrouping, measurement resolution too coarse.',
    action: 'Review data collection methods. Verify subgroups contain data from the same source.' },
  8: { name: 'Mixed Zones', short: '8 consecutive outside C', severity: 'WARNING',
    description: 'Eight consecutive points fall outside Zone C (beyond 1\u03c3 on either side) with points on both sides. This bimodal pattern suggests mixture.',
    cause: 'Two distinct processes or conditions being mixed, alternating operators with different techniques.',
    action: 'Separate and analyze data by source. Identify the two populations and address the cause of inconsistency.' },
};

const SAMPLE_DATA = {
  normal: {
    id: 1247, timestamp: '2026-02-07T14:23:15Z', source: 'MANUAL', batch: 'LOT-2026-0089',
    operator: 'jsmith', charName: 'Outer Diameter',
    measurements: [10.023, 10.018, 10.031, 10.025, 10.019],
    mean: 10.0232, range: 0.013, stdDev: 0.0052,
    zone: 'C', zoneLabel: 'Zone C', zoneColor: 'green',
    ucl: 10.06, lcl: 9.94, center: 10.0,
    violations: [], actual_n: 5, nominal_n: 5,
  },
  rule1: {
    id: 1248, timestamp: '2026-02-07T14:28:42Z', source: 'AUTO', batch: 'LOT-2026-0089',
    operator: 'auto-gauge-03', charName: 'Outer Diameter',
    measurements: [10.082, 10.075, 10.068, 10.071, 10.079],
    mean: 10.0750, range: 0.014, stdDev: 0.0057,
    zone: 'beyond_ucl', zoneLabel: 'Beyond UCL', zoneColor: 'red',
    ucl: 10.06, lcl: 9.94, center: 10.0,
    violations: [1], actual_n: 5, nominal_n: 5,
  },
  rule2: {
    id: 1248, timestamp: '2026-02-07T14:28:42Z', source: 'MANUAL', batch: 'LOT-2026-0090',
    operator: 'jdoe', charName: 'Outer Diameter',
    measurements: [10.015, 10.022, 10.008, 10.019, 10.011],
    mean: 10.0150, range: 0.014, stdDev: 0.0055,
    zone: 'C', zoneLabel: 'Zone C (above)', zoneColor: 'green',
    ucl: 10.06, lcl: 9.94, center: 10.0,
    violations: [2], actual_n: 5, nominal_n: 5,
  },
  multi: {
    id: 1250, timestamp: '2026-02-07T15:01:33Z', source: 'AUTO', batch: 'LOT-2026-0091',
    operator: 'auto-gauge-01', charName: 'Outer Diameter',
    measurements: [10.065, 10.058, 10.072, 10.061],
    mean: 10.0640, range: 0.014, stdDev: 0.0059,
    zone: 'beyond_ucl', zoneLabel: 'Beyond UCL', zoneColor: 'red',
    ucl: 10.06, lcl: 9.94, center: 10.0,
    violations: [1, 5], actual_n: 4, nominal_n: 5,
  },
};

const ANNOTATIONS = [
  { text: 'Retooled station after calibration drift detected. Verified with gage R&R.', color: '#6366f1', author: 'jsmith', time: '2026-02-07 14:30' },
  { text: 'Material lot changed - new supplier batch.', color: '#f59e0b', author: 'jdoe', time: '2026-02-07 13:15' },
];

const EDIT_HISTORY = [
  { who: 'jsmith', when: '2026-02-07 14:35', reason: 'Corrected transcription error on M3 — operator misread digital caliper.',
    oldValues: [10.023, 10.018, 10.051, 10.025, 10.019], oldMean: 10.0272,
    newValues: [10.023, 10.018, 10.031, 10.025, 10.019], newMean: 10.0232 },
  { who: 'admin', when: '2026-02-07 15:10', reason: 'Supervisor-approved adjustment per NCR-2026-0044.',
    oldValues: [10.023, 10.018, 10.031, 10.025, 10.019], oldMean: 10.0232,
    newValues: [10.024, 10.018, 10.031, 10.025, 10.020], newMean: 10.0236 },
];

const ROLE_HIERARCHY = { operator: 1, supervisor: 2, engineer: 3, admin: 4 };

const LAYOUTS = ['tabbed', 'sectioned', 'sidebar'];
const ROLES = ['operator', 'supervisor', 'engineer', 'admin'];
const VIOLATION_PRESETS = ['none', 'rule-1', 'rule-2', 'multi'];

// ════════════════════════════════════════════════════════════
// STATE
// ════════════════════════════════════════════════════════════

const DEFAULTS = {
  layout: 'tabbed',
  role: 'supervisor',
  violationPreset: 'none',
  hasViolations: false,
  isModified: false,
  isUndersized: false,
  isExcluded: false,
  hasAnnotations: true,
  showBars: true,
  expandViolations: true,
  isEditing: false,
  activeTab: 'measurements',
  activeSidebarItem: 'measurements',
};

const state = { ...DEFAULTS };

function getSampleData() {
  if (state.violationPreset === 'rule-1') return { ...SAMPLE_DATA.rule1 };
  if (state.violationPreset === 'rule-2') return { ...SAMPLE_DATA.rule2 };
  if (state.violationPreset === 'multi') return { ...SAMPLE_DATA.multi };
  return { ...SAMPLE_DATA.normal };
}

function canDo(action) {
  const reqs = { 'samples:edit': 'supervisor', 'violations:acknowledge': 'supervisor', 'characteristics:edit': 'engineer' };
  const req = reqs[action];
  if (!req) return false;
  return ROLE_HIERARCHY[state.role] >= ROLE_HIERARCHY[req];
}

// ════════════════════════════════════════════════════════════
// CONTROLS INIT
// ════════════════════════════════════════════════════════════

function buildControls() {
  // Presets
  const presetData = [
    { id: 'clean', label: 'Clean Sample' },
    { id: 'violation', label: 'Rule 1 Violation' },
    { id: 'edited-multi', label: 'Edited + Multi-Violation' },
    { id: 'undersized', label: 'Undersized + Excluded' },
    { id: 'operator-view', label: 'Operator View' },
  ];
  const presetsEl = document.getElementById('presets');
  presetData.forEach(p => {
    const btn = document.createElement('button');
    btn.className = 'preset-btn';
    btn.textContent = p.label;
    btn.dataset.preset = p.id;
    btn.onclick = () => applyPreset(p.id);
    presetsEl.appendChild(btn);
  });

  // Layout radios
  buildRadioGroup('layout-radios', LAYOUTS.map(l => ({
    value: l, label: l.charAt(0).toUpperCase() + l.slice(1)
  })), 'layout');

  // Role radios
  buildRadioGroup('role-radios', ROLES.map(r => ({
    value: r, label: r.charAt(0).toUpperCase() + r.slice(1)
  })), 'role');

  // Violation preset radios
  buildRadioGroup('violation-radios', [
    { value: 'none', label: 'None' },
    { value: 'rule-1', label: 'Rule 1' },
    { value: 'rule-2', label: 'Rule 2' },
    { value: 'multi', label: 'Multi' },
  ], 'violationPreset');
}

function buildRadioGroup(containerId, options, stateKey) {
  const container = document.getElementById(containerId);
  options.forEach(opt => {
    const label = document.createElement('label');
    const input = document.createElement('input');
    input.type = 'radio';
    input.name = stateKey;
    input.value = opt.value;
    input.checked = state[stateKey] === opt.value;
    input.onchange = () => {
      state[stateKey] = opt.value;
      if (stateKey === 'violationPreset') {
        state.hasViolations = opt.value !== 'none';
        if (opt.value === 'multi') {
          state.isUndersized = true;
        }
        syncToggles();
      }
      updateAll();
    };
    const span = document.createElement('span');
    span.textContent = opt.label;
    label.appendChild(input);
    label.appendChild(span);
    container.appendChild(label);
  });
}

function toggleState(key) {
  state[key] = !state[key];
  if (key === 'hasViolations' && state.hasViolations && state.violationPreset === 'none') {
    state.violationPreset = 'rule-1';
    syncRadios('violationPreset');
  }
  if (key === 'hasViolations' && !state.hasViolations) {
    state.violationPreset = 'none';
    syncRadios('violationPreset');
  }
  syncToggles();
  updateAll();
}

function syncToggles() {
  ['violations', 'modified', 'undersized', 'excluded', 'annotations', 'bars', 'expand-viol', 'editing'].forEach(k => {
    const map = {
      'violations': 'hasViolations', 'modified': 'isModified', 'undersized': 'isUndersized',
      'excluded': 'isExcluded', 'annotations': 'hasAnnotations', 'bars': 'showBars',
      'expand-viol': 'expandViolations', 'editing': 'isEditing'
    };
    const el = document.getElementById('tog-' + k);
    if (el) el.classList.toggle('on', state[map[k]]);
  });
}

function syncRadios(key) {
  document.querySelectorAll(`input[name="${key}"]`).forEach(input => {
    input.checked = input.value === state[key];
  });
}

// ════════════════════════════════════════════════════════════
// PRESETS
// ════════════════════════════════════════════════════════════

function applyPreset(id) {
  Object.assign(state, DEFAULTS);
  switch(id) {
    case 'clean':
      state.violationPreset = 'none'; state.hasViolations = false;
      state.hasAnnotations = true;
      break;
    case 'violation':
      state.violationPreset = 'rule-1'; state.hasViolations = true;
      state.expandViolations = true;
      break;
    case 'edited-multi':
      state.violationPreset = 'multi'; state.hasViolations = true;
      state.isModified = true; state.isUndersized = true;
      state.expandViolations = true;
      break;
    case 'undersized':
      state.isUndersized = true; state.isExcluded = true;
      state.violationPreset = 'none'; state.hasViolations = false;
      break;
    case 'operator-view':
      state.role = 'operator';
      state.violationPreset = 'rule-1'; state.hasViolations = true;
      break;
  }
  // Sync all controls
  LAYOUTS.concat(ROLES).forEach(() => {});
  ['layout', 'role', 'violationPreset'].forEach(k => syncRadios(k));
  syncToggles();
  // Highlight preset button
  document.querySelectorAll('.preset-btn').forEach(b => b.classList.toggle('active', b.dataset.preset === id));
  updateAll();
}

// ════════════════════════════════════════════════════════════
// RENDER
// ════════════════════════════════════════════════════════════

function updateAll() {
  renderModal();
  updatePrompt();
}

function renderModal() {
  const root = document.getElementById('modal-root');
  const sample = getSampleData();
  const hasViol = state.hasViolations && sample.violations.length > 0;

  root.className = 'modal' + (state.layout === 'sidebar' ? ' layout-sidebar' : '');

  if (state.layout === 'tabbed') renderTabbed(root, sample, hasViol);
  else if (state.layout === 'sectioned') renderSectioned(root, sample, hasViol);
  else renderSidebar(root, sample, hasViol);
}

function renderHeader(sample) {
  const hasViol = state.hasViolations && sample.violations.length > 0;
  const pointClass = hasViol ? 'diamond' : (state.isUndersized ? 'triangle' : 'circle');
  return `
    <div class="modal-header">
      <div class="modal-header-left">
        <div class="point-shape ${pointClass}"></div>
        <h2>Sample #${sample.id}</h2>
        ${hasViol ? `<span class="chip chip-red">\u26a0 ${sample.violations.length} Violation${sample.violations.length > 1 ? 's' : ''}</span>` : ''}
        ${state.isExcluded ? '<span class="chip chip-muted">Excluded</span>' : ''}
      </div>
      <button class="close-btn">\u2715</button>
    </div>`;
}

function renderOverview(sample) {
  const zoneColors = { green: '--green', amber: '--amber', red: '--red' };
  const zoneVar = zoneColors[sample.zoneColor] || '--green';
  const hasViol = state.hasViolations && sample.violations.length > 0;

  return `
    <div class="overview${state.isExcluded ? ' excluded-overlay' : ''}">
      <div class="overview-top">
        <div class="overview-value">
          <div class="label">Mean</div>
          <div class="number" style="color: var(${zoneVar})">${sample.mean.toFixed(4)}</div>
          <div class="unit">${sample.zoneLabel}</div>
        </div>
        <div class="overview-meta">
          <div class="meta-item"><span class="meta-label">Time</span><span class="meta-value">${formatTimestamp(sample.timestamp)}</span></div>
          <div class="meta-item"><span class="meta-label">Source</span><span class="meta-value">${sample.source}</span></div>
          <div class="meta-item"><span class="meta-label">Batch</span><span class="meta-value">${sample.batch}</span></div>
          <div class="meta-item"><span class="meta-label">Operator</span><span class="meta-value">${sample.operator}</span></div>
          <div class="meta-item"><span class="meta-label">Subgroup</span><span class="meta-value">n=${sample.actual_n}/${sample.nominal_n}${state.isUndersized ? ' <span style="color:var(--amber)">\u26a0</span>' : ''}</span></div>
          <div class="meta-item"><span class="meta-label">Char</span><span class="meta-value">${sample.charName}</span></div>
        </div>
      </div>
      <div class="overview-chips">
        ${hasViol ? '<span class="chip chip-red">OUT OF CONTROL</span>' : '<span class="chip chip-green">In Control</span>'}
        ${state.isModified ? '<span class="chip chip-amber">Modified 2x</span>' : ''}
        ${state.isUndersized ? '<span class="chip chip-amber">Undersized</span>' : ''}
        ${state.isExcluded ? '<span class="chip chip-muted" style="text-decoration:line-through;opacity:0.6">Excluded from Limits</span>' : ''}
      </div>
    </div>`;
}

function renderMeasurementsContent(sample) {
  const editable = state.isEditing && canDo('samples:edit');
  let html = '<div class="measurement-grid">';
  sample.measurements.forEach((v, i) => {
    html += `<div class="measurement-cell${editable ? ' editable' : ''}">
      <div class="m-label">M${i + 1}</div>
      <div class="m-value">${v.toFixed(3)}</div>
    </div>`;
  });
  html += '</div>';

  html += `<div class="stats-row">
    <div class="stat-item"><span class="stat-label">Mean</span><span class="stat-value">${sample.mean.toFixed(4)}</span></div>
    <div class="stat-item"><span class="stat-label">Range</span><span class="stat-value">${sample.range.toFixed(4)}</span></div>
    <div class="stat-item"><span class="stat-label">Std Dev</span><span class="stat-value">${sample.stdDev.toFixed(4)}</span></div>
    <div class="stat-item"><span class="stat-label">UCL</span><span class="stat-value" style="color:var(--red)">${sample.ucl.toFixed(3)}</span></div>
    <div class="stat-item"><span class="stat-label">CL</span><span class="stat-value" style="color:var(--text-dim)">${sample.center.toFixed(3)}</span></div>
    <div class="stat-item"><span class="stat-label">LCL</span><span class="stat-value" style="color:var(--red)">${sample.lcl.toFixed(3)}</span></div>
  </div>`;

  if (state.showBars) {
    html += renderMiniBars(sample);
  }

  if (editable) {
    html += `<div class="edit-reason">
      <label>Reason for Change <span style="color:var(--red)">*</span></label>
      <div class="fake-textarea">Describe why this sample is being modified...</div>
      <div class="btn-row">
        <button class="btn btn-ghost" onclick="state.isEditing=false;syncToggles();updateAll()">Cancel</button>
        <button class="btn btn-primary" disabled>Save Changes</button>
      </div>
    </div>`;
  } else if (canDo('samples:edit') && !state.isEditing) {
    html += `<div style="display:flex;gap:8px;margin-top:8px">
      <button class="btn btn-ghost" onclick="state.isEditing=true;syncToggles();updateAll()">\u270e Edit Measurements</button>
      ${state.isExcluded
        ? '<button class="btn btn-ghost">\u21a9 Restore Sample</button>'
        : '<button class="btn btn-ghost" style="color:var(--amber)">\u2298 Exclude Sample</button>'}
    </div>`;
  }

  return html;
}

function renderMiniBars(sample) {
  const min = sample.lcl - (sample.ucl - sample.lcl) * 0.2;
  const max = sample.ucl + (sample.ucl - sample.lcl) * 0.2;
  const range = max - min;

  let bars = '';
  sample.measurements.forEach(v => {
    const pct = Math.max(5, Math.min(95, ((v - min) / range) * 100));
    let color = 'var(--green)';
    if (v > sample.ucl || v < sample.lcl) color = 'var(--red)';
    else if (v > sample.center + (sample.ucl - sample.center) * 0.67 || v < sample.center - (sample.center - sample.lcl) * 0.67) color = 'var(--amber)';
    bars += `<div class="bar" style="height:${pct}%;background:${color}"></div>`;
  });

  return `<div class="mini-bars">
    <div class="limit-line ucl"></div>
    <div class="limit-line center"></div>
    <div class="limit-line lcl"></div>
    ${bars}
  </div>`;
}

function renderViolationsContent(sample) {
  if (!state.hasViolations || sample.violations.length === 0) {
    return '<div style="text-align:center;color:var(--text-dim);padding:20px;font-size:12px">No violations detected</div>';
  }

  let html = '';
  sample.violations.forEach(ruleId => {
    const rule = NELSON_RULES[ruleId];
    const sevClass = rule.severity === 'CRITICAL' ? 'critical' : (rule.severity === 'INFO' ? 'info' : 'warning');
    const sevBg = rule.severity === 'CRITICAL' ? 'var(--red-soft)' : (rule.severity === 'INFO' ? 'var(--blue-soft)' : 'var(--amber-soft)');
    const sevColor = rule.severity === 'CRITICAL' ? 'var(--red)' : (rule.severity === 'INFO' ? 'var(--blue)' : 'var(--amber)');

    html += `<div class="violation-card">
      <div class="violation-card-header">
        <div class="violation-card-left">
          <div class="violation-rule-num ${sevClass}">${ruleId}</div>
          <div>
            <div class="violation-name">${rule.name}</div>
            <div class="violation-short">${rule.short}</div>
          </div>
        </div>
        <span class="chip" style="background:${sevBg};color:${sevColor}">${rule.severity}</span>
      </div>`;

    if (state.expandViolations) {
      html += renderViolationSparkline(ruleId);
      html += `<div class="violation-body">
        <div class="violation-section">
          <div class="violation-section-title">What This Detects</div>
          <p>${rule.description}</p>
        </div>
        <div class="violation-section">
          <div class="violation-section-title">Common Causes</div>
          <p>${rule.cause}</p>
        </div>
        <div class="violation-section">
          <div class="violation-section-title">Recommended Action</div>
          <p>${rule.action}</p>
        </div>
      </div>`;
    }

    if (canDo('violations:acknowledge')) {
      html += `<div class="ack-area">
        <span class="ack-text">Requires acknowledgement</span>
        <button class="btn btn-amber">Acknowledge</button>
      </div>`;
    } else {
      html += `<div class="ack-area">
        <span class="ack-text">Contact a supervisor to acknowledge this violation</span>
      </div>`;
    }

    html += '</div>';
  });

  return html;
}

function renderViolationSparkline(ruleId) {
  // Generate a simple SVG sparkline for the violation pattern
  const w = 280, h = 32, pad = 4;
  const pts = [];
  const n = ruleId === 4 ? 16 : (ruleId === 2 ? 12 : (ruleId === 7 ? 18 : 10));

  for (let i = 0; i < n; i++) {
    let y;
    switch (ruleId) {
      case 1: y = i === n-1 ? 3 : 14 + Math.sin(i*0.8)*4; break;
      case 2: y = 8 + Math.sin(i*0.5)*3; break; // all above center
      case 3: y = 24 - i * 1.8; break; // trending up
      case 4: y = i % 2 === 0 ? 8 : 24; break; // alternating
      case 5: y = i >= n-3 ? (i === n-2 ? 16 : 4) : 14 + Math.sin(i)*3; break;
      case 6: y = i >= n-5 ? 7 + Math.random()*3 : 14 + Math.sin(i)*4; break;
      case 7: y = 14 + Math.sin(i*0.7)*2; break; // tight cluster
      case 8: y = i % 2 === 0 ? 6 : 26; break; // outside C both sides
      default: y = 16 + Math.sin(i)*6;
    }
    pts.push({ x: pad + (i / (n-1)) * (w - 2*pad), y: Math.max(2, Math.min(30, y)) });
  }

  const pathD = pts.map((p, i) => (i === 0 ? 'M' : 'L') + `${p.x.toFixed(1)},${p.y.toFixed(1)}`).join(' ');
  const lastPt = pts[pts.length - 1];
  const sevColor = NELSON_RULES[ruleId].severity === 'CRITICAL' ? '#ef4444' : (NELSON_RULES[ruleId].severity === 'INFO' ? '#3b82f6' : '#f59e0b');

  return `<div class="violation-sparkline">
    <svg viewBox="0 0 ${w} ${h}">
      <line x1="${pad}" y1="16" x2="${w-pad}" y2="16" stroke="#334155" stroke-width="0.5" stroke-dasharray="3,3"/>
      <line x1="${pad}" y1="4" x2="${w-pad}" y2="4" stroke="#ef4444" stroke-width="0.5" opacity="0.3"/>
      <line x1="${pad}" y1="28" x2="${w-pad}" y2="28" stroke="#ef4444" stroke-width="0.5" opacity="0.3"/>
      <path d="${pathD}" fill="none" stroke="#64748b" stroke-width="1.5"/>
      ${pts.map((p, i) => {
        const isLast = i === pts.length - 1;
        const color = isLast ? sevColor : '#94a3b8';
        const r = isLast ? 3.5 : 2;
        return `<circle cx="${p.x.toFixed(1)}" cy="${p.y.toFixed(1)}" r="${r}" fill="${color}" ${isLast ? `stroke="${sevColor}" stroke-width="1.5" stroke-opacity="0.4"` : ''}/>`;
      }).join('')}
    </svg>
  </div>`;
}

function renderAnnotationsContent() {
  let html = '';

  if (state.hasAnnotations) {
    ANNOTATIONS.forEach(a => {
      html += `<div class="annotation-item">
        <div class="annotation-color-dot" style="background:${a.color}"></div>
        <div class="annotation-content">
          <div class="annotation-text">${a.text}</div>
          <div class="annotation-meta">${a.author} \u00b7 ${a.time}</div>
        </div>
      </div>`;
    });
  } else {
    html += '<div style="text-align:center;color:var(--text-dim);padding:16px;font-size:12px">No annotations for this sample</div>';
  }

  html += `<div class="add-annotation-form">
    <div style="font-size:11px;font-weight:600;color:var(--text-muted);margin-bottom:8px">Add Annotation</div>
    <div class="form-row">
      <div class="color-dot-input" style="background:var(--primary)"></div>
      <div class="fake-input">Note about this data point...</div>
      <button class="btn btn-primary" disabled>Add</button>
    </div>
  </div>`;

  return html;
}

function renderHistoryContent() {
  if (!state.isModified) {
    return '<div style="text-align:center;color:var(--text-dim);padding:20px;font-size:12px">No edit history</div>';
  }

  let html = '<div class="history-timeline">';
  EDIT_HISTORY.forEach(entry => {
    html += `<div class="history-entry">
      <div class="entry-header">
        <span class="entry-who">${entry.who}</span>
        <span class="entry-when">${entry.when}</span>
      </div>
      <div class="entry-reason">"${entry.reason}"</div>
      <div class="entry-diff">
        <span class="diff-old">\u0078\u0304 ${entry.oldMean.toFixed(4)}</span>
        <span class="diff-arrow">\u2192</span>
        <span class="diff-new">\u0078\u0304 ${entry.newMean.toFixed(4)}</span>
      </div>
    </div>`;
  });
  html += '</div>';
  return html;
}

// ─── Layout: Tabbed ───
function renderTabbed(root, sample, hasViol) {
  const tabs = buildTabList(sample, hasViol);
  if (!tabs.find(t => t.id === state.activeTab)) state.activeTab = tabs[0].id;

  root.innerHTML = renderHeader(sample) + renderOverview(sample) + `
    <div class="tab-bar">${tabs.map(t => `
      <button class="tab-btn${state.activeTab === t.id ? ' active' : ''}" onclick="state.activeTab='${t.id}';updateAll()">
        ${t.label}${t.badge || ''}
      </button>`).join('')}
    </div>
    <div class="tab-content">
      ${tabs.map(t => `<div class="tab-panel${state.activeTab === t.id ? ' active' : ''}">${t.render(sample)}</div>`).join('')}
    </div>`;
}

// ─── Layout: Sectioned ───
function renderSectioned(root, sample, hasViol) {
  const sections = buildTabList(sample, hasViol);

  root.innerHTML = renderHeader(sample) + `
    <div class="section-layout" style="overflow-y:auto;max-height:calc(80vh - 60px)">
      ${renderOverview(sample)}
      ${sections.map(s => `
        <div class="section-block">
          <div class="section-block-title">${s.label} ${s.badge || ''}</div>
          ${s.render(sample)}
        </div>`).join('')}
    </div>`;
}

// ─── Layout: Sidebar ───
function renderSidebar(root, sample, hasViol) {
  const tabs = buildTabList(sample, hasViol);
  if (!tabs.find(t => t.id === state.activeSidebarItem)) state.activeSidebarItem = tabs[0].id;
  const active = tabs.find(t => t.id === state.activeSidebarItem) || tabs[0];

  root.innerHTML = `
    <div class="sidebar-left">
      <div style="padding:12px 16px 16px;border-bottom:1px solid var(--border)">
        <div style="font-size:13px;font-weight:600">Sample #${sample.id}</div>
        <div style="font-size:10px;color:var(--text-dim);margin-top:2px">${formatTimestamp(sample.timestamp)}</div>
      </div>
      ${tabs.map(t => `
        <div class="sidebar-item${state.activeSidebarItem === t.id ? ' active' : ''}" onclick="state.activeSidebarItem='${t.id}';updateAll()">
          ${t.label} ${t.badge || ''}
        </div>`).join('')}
    </div>
    <div class="sidebar-main">
      ${renderOverview(sample)}
      <div class="tab-content">
        ${active.render(sample)}
      </div>
    </div>`;
}

function buildTabList(sample, hasViol) {
  const tabs = [
    { id: 'measurements', label: 'Measurements', render: renderMeasurementsContent },
  ];
  if (hasViol) {
    const count = sample.violations.length;
    tabs.push({
      id: 'violations', label: 'Violations',
      badge: `<span class="tab-badge tab-badge-red">${count}</span>`,
      render: renderViolationsContent
    });
  }
  tabs.push({
    id: 'annotations', label: 'Annotations',
    badge: state.hasAnnotations ? `<span class="tab-badge tab-badge-amber">${ANNOTATIONS.length}</span>` : '',
    render: () => renderAnnotationsContent()
  });
  if (state.isModified) {
    tabs.push({
      id: 'history', label: 'Edit History',
      badge: `<span class="tab-badge tab-badge-amber">${EDIT_HISTORY.length}</span>`,
      render: renderHistoryContent
    });
  }
  return tabs;
}

// ════════════════════════════════════════════════════════════
// PROMPT
// ════════════════════════════════════════════════════════════

function updatePrompt() {
  const parts = [];

  parts.push(`Implement a unified "Sample Inspector" modal that opens when clicking any data point on the SPC control chart. This replaces the current annotation-only dialog.`);

  // Layout
  if (state.layout === 'tabbed') {
    parts.push(`Use a tabbed layout: a fixed overview header at top showing sample metadata and mean value, then tab bar with content panels below.`);
  } else if (state.layout === 'sectioned') {
    parts.push(`Use a vertically scrollable sectioned layout: overview header at top, then all content sections stacked with section titles, no tabs.`);
  } else {
    parts.push(`Use a sidebar+main layout: left sidebar with section navigation, main area showing overview header and active section content.`);
  }

  // Overview
  parts.push(`\n\nOVERVIEW (always visible): Show sample ID, large color-coded mean value (green=normal, amber=Zone B, red=Zone A/beyond UCL), timestamp, source, batch, operator, subgroup size with undersized warning. Status chips for: In Control/OUT OF CONTROL, Modified Nx, Undersized, Excluded.`);

  // Measurements
  parts.push(`\n\nMEASUREMENTS section: Grid of individual measurement cells (M1, M2, ...) with computed stats (mean, range, std dev, UCL, CL, LCL).${state.showBars ? ' Include a mini bar chart showing measurement spread relative to control limits.' : ''} For supervisor+ roles, show "Edit Measurements" button that enables inline editing with a required reason field. Also show Exclude/Restore button for supervisor+.`);

  // Violations
  if (state.hasViolations) {
    parts.push(`\n\nVIOLATIONS section (tab/section with red badge count): For each triggered Nelson rule, show: rule number in colored circle, rule name, severity chip (CRITICAL/WARNING/INFO), expandable details with "What This Detects", "Common Causes", and "Recommended Action" descriptions. Include a mini sparkline SVG showing the triggering pattern.${canDo('violations:acknowledge') ? ' Show "Acknowledge" button for supervisor+ roles.' : ' Show "Contact supervisor" message for operator role.'}`);
  }

  // Annotations
  parts.push(`\n\nANNOTATIONS section: List existing annotations with color dot, text, author, and timestamp. Include inline "Add Annotation" form with color picker and text input.`);

  // History
  if (state.isModified) {
    parts.push(`\n\nEDIT HISTORY section (only shown when sample has been modified): Timeline of edits showing who, when, reason (italic quote), and before/after mean values with diff styling (red strikethrough old, green new).`);
  }

  // Role gating
  parts.push(`\n\nROLE-BASED ACCESS: Gate edit/exclude/acknowledge actions behind role checks using canPerformAction(). Operators see read-only views. Supervisors+ can edit samples, acknowledge violations. The modal should dynamically show/hide action buttons based on the current user's role.`);

  // Excluded
  if (state.isExcluded) {
    parts.push(` When a sample is excluded, overlay a faint "EXCLUDED" watermark on the overview section.`);
  }

  document.getElementById('prompt-output').textContent = parts.join('');
}

// ════════════════════════════════════════════════════════════
// UTILS
// ════════════════════════════════════════════════════════════

function formatTimestamp(iso) {
  const d = new Date(iso);
  return d.toLocaleDateString(undefined, { month: 'short', day: 'numeric' }) + ' ' +
    d.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit', hour12: true });
}

function copyPrompt() {
  const text = document.getElementById('prompt-output').textContent;
  navigator.clipboard.writeText(text).then(() => {
    const btn = document.getElementById('copy-btn');
    btn.textContent = 'Copied!';
    btn.classList.add('copied');
    setTimeout(() => { btn.textContent = 'Copy Prompt'; btn.classList.remove('copied'); }, 1500);
  });
}

// ════════════════════════════════════════════════════════════
// INIT
// ════════════════════════════════════════════════════════════

buildControls();
syncToggles();
applyPreset('clean');
</script>

</body>
</html>
